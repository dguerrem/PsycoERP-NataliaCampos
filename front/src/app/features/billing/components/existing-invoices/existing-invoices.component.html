<!-- Contenido Facturas Existentes -->
<div data-slot="tabs-content" class="flex-1 outline-none mt-0 h-full">
  <div class="p-6 h-full flex flex-col">

    <!-- Filtros superiores -->
    <div class="flex items-center gap-4 mb-6">
      <div class="flex items-center gap-2">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
          stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="h-4 w-4">
          <path d="M8 2v4"></path>
          <path d="M16 2v4"></path>
          <rect width="18" height="18" x="3" y="4" rx="2"></rect>
          <path d="M3 10h18"></path>
        </svg>
        <span class="font-medium">Facturas Existentes:</span>
      </div>

      <select [value]="existingMonth" (change)="onMonthChange($event)" data-slot="select-trigger"
        class="border-input flex items-center justify-between gap-2 rounded-md border bg-background px-3 py-2 text-sm whitespace-nowrap shadow-xs transition-[color,box-shadow] outline-none focus-visible:ring-[3px] h-9 w-40">
        @for (month of monthNames; track $index) {
        <option [value]="$index + 1" [selected]="$index + 1 === existingMonth">{{ month }}</option>
        }
      </select>

      <select [value]="existingYear" (change)="onYearChange($event)" data-slot="select-trigger"
        class="border-input flex items-center justify-between gap-2 rounded-md border bg-background px-3 py-2 text-sm whitespace-nowrap shadow-xs transition-[color,box-shadow] outline-none focus-visible:ring-[3px] h-9 w-32">
        @for (year of years; track year) {
        <option [value]="year" [selected]="year === existingYear">{{ year }}</option>
        }
      </select>

      <!-- Botón de descarga masiva -->
      <div class="flex gap-2 ml-auto">
        <button data-slot="button" (click)="onDownloadBulkInvoices()" [disabled]="selectedCount() === 0"
          class="inline-flex items-center justify-center gap-2 whitespace-nowrap rounded-md text-sm font-medium transition-all disabled:pointer-events-none disabled:opacity-50 bg-primary text-primary-foreground hover:bg-primary/90 h-9 px-4 py-2">
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="h-4 w-4">
            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
            <polyline points="7 10 12 15 17 10"></polyline>
            <line x1="12" x2="12" y1="15" y2="3"></line>
          </svg>
          @if (selectedCount() > 0) {
            Descargar {{ selectedCount() }} {{ selectedCount() === 1 ? 'factura' : 'facturas' }}
          } @else {
            Descargar facturas
          }
        </button>
      </div>
    </div>

    <!-- Tabla de facturas existentes -->
    <div class="flex-1 min-h-0">
      <div class="mb-4">
        <h3 class="text-lg font-semibold mb-2">Facturas Emitidas - {{ getExistingMonthName() }} {{ existingYear }}</h3>
        <p class="text-sm text-muted-foreground">Lista de facturas generadas en el período seleccionado</p>
      </div>

      <div class="border rounded-lg overflow-hidden bg-background"
        style="height: calc(-650px + 100vh); min-height: 450px; max-height: 600px;">
        <div class="overflow-y-auto overflow-x-auto h-full">
          @if (isLoadingExisting) {
          <div class="flex items-center justify-center h-full">
            <div class="text-muted-foreground">Cargando facturas existentes...</div>
          </div>
          } @else {
          <div data-slot="table-container" class="relative w-full overflow-x-auto">
            <table data-slot="table" class="w-full caption-bottom text-sm">
              <thead data-slot="table-header" class="[&_tr]:border-b sticky top-0 bg-background z-10 shadow-sm">
                <tr data-slot="table-row" class="hover:bg-muted/50 border-b transition-colors">
                  <th data-slot="table-head"
                    class="text-foreground h-10 px-2 text-left align-middle font-medium whitespace-nowrap w-12">
                    <input type="checkbox" [checked]="allSelected()" (change)="selectAllInvoices()" data-slot="checkbox"
                      class="peer size-4 shrink-0 rounded-[4px] border shadow-xs cursor-pointer">
                  </th>
                  <th data-slot="table-head"
                    class="text-foreground h-10 px-2 text-left align-middle font-medium whitespace-nowrap min-w-[180px]">
                    Número de Factura</th>
                  <th data-slot="table-head"
                    class="text-foreground h-10 px-2 text-left align-middle font-medium whitespace-nowrap min-w-[120px]">
                    Fecha</th>
                  <th data-slot="table-head"
                    class="text-foreground h-10 px-2 text-left align-middle font-medium whitespace-nowrap min-w-[200px]">
                    Paciente</th>
                  <th data-slot="table-head"
                    class="text-foreground h-10 px-2 text-left align-middle font-medium whitespace-nowrap min-w-[100px]">
                    DNI</th>
                  <th data-slot="table-head"
                    class="text-foreground h-10 px-2 text-left align-middle font-medium whitespace-nowrap min-w-[100px]">
                    Sesiones</th>
                  <th data-slot="table-head"
                    class="text-foreground h-10 px-2 text-left align-middle font-medium whitespace-nowrap min-w-[100px]">
                    Total</th>
                  <th data-slot="table-head"
                    class="text-foreground h-10 px-2 text-left align-middle font-medium whitespace-nowrap min-w-[80px]">
                    Acciones</th>
                </tr>
                <tr data-slot="table-row" class="border-b bg-muted/30">
                  <th data-slot="table-head" class="h-10 px-2"></th>
                  <th data-slot="table-head" class="h-10 px-2">
                    <input type="text" placeholder="Filtrar..." [value]="existingInvoiceNumberFilter()"
                      (input)="existingInvoiceNumberFilter.set($any($event.target).value)" data-slot="input"
                      class="border-input h-8 w-full min-w-0 rounded-md border bg-white px-2 py-1 text-xs shadow-xs outline-none focus-visible:ring-[2px]"
                      aria-label="Filtrar por número de factura">
                  </th>
                  <th data-slot="table-head" class="h-10 px-2">
                    <input type="text" placeholder="Filtrar..." [value]="existingDateFilter()"
                      (input)="existingDateFilter.set($any($event.target).value)" data-slot="input"
                      class="border-input h-8 w-full min-w-0 rounded-md border bg-white px-2 py-1 text-xs shadow-xs outline-none focus-visible:ring-[2px]"
                      aria-label="Filtrar por fecha">
                  </th>
                  <th data-slot="table-head" class="h-10 px-2">
                    <input type="text" placeholder="Filtrar..." [value]="existingPatientFilter()"
                      (input)="existingPatientFilter.set($any($event.target).value)" data-slot="input"
                      class="border-input h-8 w-full min-w-0 rounded-md border bg-white px-2 py-1 text-xs shadow-xs outline-none focus-visible:ring-[2px]"
                      aria-label="Filtrar por nombre de paciente">
                  </th>
                  <th data-slot="table-head" class="h-10 px-2">
                    <input type="text" placeholder="Filtrar..." [value]="existingDniFilter()"
                      (input)="existingDniFilter.set($any($event.target).value)" data-slot="input"
                      class="border-input h-8 w-full min-w-0 rounded-md border bg-white px-2 py-1 text-xs shadow-xs outline-none focus-visible:ring-[2px]"
                      aria-label="Filtrar por DNI">
                  </th>
                  <th data-slot="table-head" class="h-10 px-2"></th>
                  <th data-slot="table-head" class="h-10 px-2"></th>
                  <th data-slot="table-head" class="h-10 px-2"></th>
                </tr>
              </thead>
              <tbody data-slot="table-body" class="[&_tr:last-child]:border-0">
                @for (invoice of filteredExistingInvoices(); track invoice.id) {
                <tr data-slot="table-row" class="hover:bg-muted/50 border-b transition-colors">
                  <td data-slot="table-cell" class="p-2 align-middle whitespace-nowrap">
                    <input type="checkbox" [checked]="selectedInvoices().includes(invoice.id)"
                      (change)="toggleInvoiceSelection(invoice.id)" data-slot="checkbox"
                      class="peer size-4 shrink-0 rounded-[4px] border shadow-xs cursor-pointer">
                  </td>
                  <td data-slot="table-cell" class="p-2 align-middle whitespace-nowrap font-medium text-primary">{{
                    invoice.invoice_number }}</td>
                  <td data-slot="table-cell" class="p-2 align-middle whitespace-nowrap">{{
                    invoice.invoice_date }}</td>
                  <td data-slot="table-cell" class="p-2 align-middle whitespace-nowrap font-medium">{{
                    invoice.patient_full_name }}</td>
                  <td data-slot="table-cell" class="p-2 align-middle whitespace-nowrap">{{ invoice.dni }}
                  </td>
                  <td data-slot="table-cell" class="p-2 align-middle whitespace-nowrap">
                    <span data-slot="badge"
                      class="inline-flex items-center justify-center rounded-md border px-2 py-0.5 text-xs font-medium w-fit whitespace-nowrap text-foreground">
                      {{ invoice.sessions_count }} {{ invoice.sessions_count === 1 ? 'sesión' : 'sesiones'
                      }}
                    </span>
                  </td>
                  <td data-slot="table-cell" class="p-2 align-middle whitespace-nowrap font-semibold">{{
                    formatCurrency(invoice.total) }}</td>
                  <td data-slot="table-cell" class="p-2 align-middle whitespace-nowrap">
                    <button data-slot="button" type="button" (click)="onPreviewInvoice(invoice)"
                      class="inline-flex items-center justify-center whitespace-nowrap text-sm font-medium transition-all disabled:pointer-events-none disabled:opacity-50 hover:bg-accent hover:text-accent-foreground h-8 rounded-md gap-1.5 px-3"
                      aria-label="Ver factura">
                      <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
                        stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                        class="h-4 w-4">
                        <path
                          d="M2.062 12.348a1 1 0 0 1 0-.696 10.75 10.75 0 0 1 19.876 0 1 1 0 0 1 0 .696 10.75 10.75 0 0 1-19.876 0">
                        </path>
                        <circle cx="12" cy="12" r="3"></circle>
                      </svg>
                    </button>
                  </td>
                </tr>
                } @empty {
                <tr>
                  <td colspan="8" class="text-center py-12 text-muted-foreground">
                    <div class="flex flex-col items-center gap-2">
                      <svg class="h-12 w-12 text-muted-foreground" fill="none" stroke="currentColor"
                        viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                          d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                      </svg>
                      <p class="font-medium">No hay facturas emitidas en este período</p>
                      <p class="text-sm">Cambia el período o genera nuevas facturas desde la pestaña de
                        Facturación</p>
                    </div>
                  </td>
                </tr>
                }
              </tbody>
            </table>
          </div>
          }
        </div>
      </div>
    </div>

  </div>
</div>
