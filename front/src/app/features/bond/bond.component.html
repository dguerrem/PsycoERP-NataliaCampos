<div class="h-full p-3 sm:p-4 lg:p-6 overflow-auto">
  <div class="h-full flex flex-col">

    <!-- Header -->
    <div class="flex items-center justify-between mb-6">
      <div>
        <h2 class="text-xl font-semibold">Bonos</h2>
        <p class="text-sm text-muted-foreground">Gestión de bonos promocionales y paquetes de sesiones</p>
      </div>
      <button
        (click)="openCreateModal()"
        style="background-color: #d29f67"
        class="hover:opacity-90 inline-flex items-center justify-center px-4 py-2 text-white rounded-md transition-opacity font-medium text-sm">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
        </svg>
        Nuevo Bono
      </button>
    </div>

    <!-- Summary Cards -->
    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
      <!-- Total Bonos -->
      <div class="bg-card text-card-foreground flex flex-col gap-6 rounded-xl border py-6 shadow-sm">
        <div class="p-4">
          <div class="text-center">
            <div class="text-2xl font-bold text-primary">{{ summary().total }}</div>
            <p class="text-sm text-muted-foreground">Total Bonos</p>
          </div>
        </div>
      </div>

      <!-- Activos -->
      <div class="bg-card text-card-foreground flex flex-col gap-6 rounded-xl border py-6 shadow-sm">
        <div class="p-4">
          <div class="text-center">
            <div class="text-2xl font-bold text-green-600">{{ summary().active }}</div>
            <p class="text-sm text-muted-foreground">Activos</p>
          </div>
        </div>
      </div>

      <!-- Consumidos -->
      <div class="bg-card text-card-foreground flex flex-col gap-6 rounded-xl border py-6 shadow-sm">
        <div class="p-4">
          <div class="text-center">
            <div class="text-2xl font-bold text-blue-600">{{ summary().consumed }}</div>
            <p class="text-sm text-muted-foreground">Consumidos</p>
          </div>
        </div>
      </div>

      <!-- Expirados -->
      <div class="bg-card text-card-foreground flex flex-col gap-6 rounded-xl border py-6 shadow-sm">
        <div class="p-4">
          <div class="text-center">
            <div class="text-2xl font-bold text-red-600">{{ summary().expired }}</div>
            <p class="text-sm text-muted-foreground">Expirados</p>
          </div>
        </div>
      </div>
    </div>

    <!-- Bonuses List -->
    <div class="flex-1 overflow-y-auto">
      @if (bonuses().length > 0) {
        <div class="space-y-4">
          @for (bonus of bonuses(); track bonus.id) {
            <div class="bg-card text-card-foreground flex flex-col gap-6 rounded-xl border py-6 shadow-sm hover:shadow-md transition-shadow">
              <!-- Card Header -->
              <div class="px-6">
                <div class="flex items-start justify-between">
                  <div>
                    <div class="font-semibold text-lg">{{ bonus.patientName }}</div>
                    <p class="text-sm text-muted-foreground">
                      Bono #{{ bonus.id }} • {{ bonus.totalSessions }} sesiones • {{ bonus.pricePerSession }}€ por sesión
                    </p>
                  </div>
                  <span
                    class="inline-flex items-center justify-center rounded-md border px-2 py-0.5 text-xs font-medium w-fit whitespace-nowrap shrink-0"
                    [ngClass]="getStatusColor(bonus.status)">
                    {{ getStatusLabel(bonus.status) }}
                  </span>
                </div>
              </div>

              <!-- Card Content -->
              <div class="px-6">
                <div class="space-y-4">
                  <!-- Progress Bar -->
                  <div>
                    <div class="flex items-center justify-between mb-2">
                      <span class="text-sm font-medium">Progreso</span>
                      <span class="text-sm text-muted-foreground">
                        {{ bonus.usedSessions }} / {{ bonus.totalSessions }} sesiones
                      </span>
                    </div>
                    <div class="bg-primary/20 relative w-full overflow-hidden rounded-full h-2">
                      <div
                        class="bg-primary h-full transition-all"
                        [style.width.%]="calculateProgress(bonus)">
                      </div>
                    </div>
                  </div>

                  <!-- Details Grid -->
                  <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-sm">
                    <div>
                      <p class="text-muted-foreground">Precio Total</p>
                      <p class="font-semibold">{{ bonus.totalPrice }}€</p>
                    </div>
                    <div>
                      <p class="text-muted-foreground">Fecha Compra</p>
                      <p class="font-semibold">{{ bonus.purchaseDate | date:'d/M/y' }}</p>
                    </div>
                    <div>
                      <p class="text-muted-foreground">Fecha Expiración</p>
                      <p class="font-semibold">{{ bonus.expiryDate | date:'d/M/y' }}</p>
                    </div>
                    <div>
                      <p class="text-muted-foreground">Sesiones Restantes</p>
                      <p class="font-semibold">{{ getRemainingSession(bonus) }}</p>
                    </div>
                  </div>

                  <!-- Actions -->
                  @if (bonus.status === 'active') {
                    <div class="flex gap-2 pt-2 flex-wrap">
                      <button
                        (click)="openEditModal(bonus)"
                        class="inline-flex items-center justify-center whitespace-nowrap text-sm font-medium transition-all border bg-background shadow-xs hover:bg-accent hover:text-accent-foreground h-8 rounded-md gap-1.5 px-3">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                        </svg>
                        Editar
                      </button>
                      <button
                        (click)="openHistoryModal(bonus)"
                        class="inline-flex items-center justify-center whitespace-nowrap text-sm font-medium transition-all border bg-background shadow-xs hover:bg-accent hover:text-accent-foreground h-8 rounded-md gap-1.5 px-3">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 2v4M16 2v4M3 10h18M5 4h14a2 2 0 012 2v14a2 2 0 01-2 2H5a2 2 0 01-2-2V6a2 2 0 012-2z" />
                        </svg>
                        Ver Historial
                      </button>
                    </div>
                  }
                </div>
              </div>
            </div>
          }
        </div>
      } @else {
        <!-- Empty State -->
        <div class="text-center py-12">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 mx-auto mb-4 opacity-50" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v13m0-13V6a2 2 0 112 2h-2zm0 0V5.5A2.5 2.5 0 109.5 8H12zm-7 4h14M5 12a2 2 0 110-4h14a2 2 0 110 4M5 12v7a2 2 0 002 2h10a2 2 0 002-2v-7" />
          </svg>
          <p class="text-muted-foreground">No hay bonos para este paciente.</p>
          <button
            (click)="openCreateModal()"
            style="background-color: #d29f67"
            class="mt-4 hover:opacity-90 inline-flex items-center justify-center px-4 py-2 text-white rounded-md transition-opacity font-medium text-sm">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
            </svg>
            Crear Primer Bono
          </button>
        </div>
      }
    </div>

  </div>
</div>

<!-- Create Bonus Modal -->
@if (isCreatingBonus()) {
  <div class="fixed inset-0 z-50 flex items-center justify-center bg-black/50">
    <div class="bg-white rounded-lg shadow-xl max-w-md w-full mx-4">
      <div class="p-6">
        <h3 class="text-lg font-semibold mb-4">Crear Nuevo Bono</h3>

        <form [formGroup]="bonusForm" class="space-y-4">
          <!-- Patient Selector -->
          <div>
            <app-patient-selector
              [control]="$any(bonusForm.get('patientId'))"
              [patients]="patients()"
              [label]="'Paciente'"
              [placeholder]="'Seleccionar paciente...'"
              [required]="true">
            </app-patient-selector>
          </div>

          <!-- Total Sessions -->
          <div>
            <label for="totalSessions" class="block text-sm font-medium text-gray-700 mb-1">
              Número de Sesiones
            </label>
            <input
              id="totalSessions"
              type="number"
              formControlName="totalSessions"
              class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent"
              min="1"
            />
          </div>

          <!-- Price Per Session -->
          <div>
            <label for="pricePerSession" class="block text-sm font-medium text-gray-700 mb-1">
              Precio por Sesión (€)
            </label>
            <input
              id="pricePerSession"
              type="number"
              formControlName="pricePerSession"
              class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent"
              min="0"
              step="0.01"
            />
          </div>

          <!-- Total Price -->
          <div>
            <label for="totalPrice" class="block text-sm font-medium text-gray-700 mb-1">
              Precio Total (€)
            </label>
            <input
              id="totalPrice"
              type="number"
              formControlName="totalPrice"
              class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent"
              min="0"
              step="0.01"
            />
          </div>

          <!-- Expiry Date -->
          <div>
            <label for="expiryDate" class="block text-sm font-medium text-gray-700 mb-1">
              Fecha de Expiración
            </label>
            <input
              id="expiryDate"
              type="date"
              formControlName="expiryDate"
              class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent"
            />
          </div>

          <!-- Actions -->
          <div class="flex justify-end gap-2 pt-4">
            <button
              type="button"
              (click)="closeCreateModal()"
              class="px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-md hover:bg-gray-50">
              Cancelar
            </button>
            <button
              type="button"
              (click)="handleCreateBonus()"
              [disabled]="!bonusForm.valid"
              style="background-color: #d29f67"
              class="px-4 py-2 text-sm font-medium text-white rounded-md hover:opacity-90 disabled:opacity-50 disabled:cursor-not-allowed">
              Crear Bono
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>
}

<!-- History Modal -->
@if (selectedBonusHistory()) {
  <div class="fixed inset-0 z-50 flex items-center justify-center bg-black/50">
    <div class="bg-white rounded-lg shadow-xl max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto">
      <div class="p-6">
        <h3 class="text-lg font-semibold mb-4">Historial del Bono #{{ selectedBonusHistory()!.id }}</h3>

        <div class="space-y-4">
          <!-- Summary Cards -->
          <div class="grid grid-cols-3 gap-4 p-4 bg-muted rounded-lg">
            <div>
              <p class="text-sm text-muted-foreground">Sesiones Usadas</p>
              <p class="text-lg font-semibold">{{ selectedBonusHistory()!.usedSessions }}</p>
            </div>
            <div>
              <p class="text-sm text-muted-foreground">Sesiones Restantes</p>
              <p class="text-lg font-semibold">{{ getRemainingSession(selectedBonusHistory()!) }}</p>
            </div>
            <div>
              <p class="text-sm text-muted-foreground">Progreso</p>
              <p class="text-lg font-semibold">{{ calculateProgress(selectedBonusHistory()!).toFixed(0) }}%</p>
            </div>
          </div>

          <!-- Sessions Table or Empty State -->
          @if (selectedBonusHistory()!.usedSessions > 0) {
            <div>
              <h4 class="font-medium mb-3">Sesiones Realizadas</h4>
              <div class="border rounded-lg overflow-hidden">
                <table class="min-w-full divide-y divide-gray-200">
                  <thead class="bg-gray-50">
                    <tr>
                      <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Fecha y hora</th>
                      <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Sesión</th>
                      <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Estado</th>
                    </tr>
                  </thead>
                  <tbody class="bg-white divide-y divide-gray-200">
                    @for (session of getBonusHistory(selectedBonusHistory()!); track session.session) {
                      <tr>
                        <td class="px-4 py-3 text-sm text-gray-900">{{ session.date }}</td>
                        <td class="px-4 py-3 text-sm text-gray-900">{{ session.session }}</td>
                        <td class="px-4 py-3 text-sm">
                          <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-green-100 text-green-800">
                            {{ session.status }}
                          </span>
                        </td>
                      </tr>
                    }
                  </tbody>
                </table>
              </div>
            </div>
          } @else {
            <div class="text-center py-8">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 mx-auto mb-4 opacity-50" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 2v4M16 2v4M3 10h18M5 4h14a2 2 0 012 2v14a2 2 0 01-2 2H5a2 2 0 01-2-2V6a2 2 0 012-2z" />
              </svg>
              <p class="text-muted-foreground">No se han usado sesiones de este bono aún.</p>
            </div>
          }

          <!-- Close Button -->
          <div class="flex justify-end pt-4">
            <button
              type="button"
              (click)="closeHistoryModal()"
              class="px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-md hover:bg-gray-50">
              Cerrar
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>
}

<!-- Edit Bonus Modal -->
@if (editingBonus()) {
  <div class="fixed inset-0 z-50 flex items-center justify-center bg-black/50">
    <div class="bg-white rounded-lg shadow-xl max-w-md w-full mx-4">
      <div class="p-6">
        <h3 class="text-lg font-semibold mb-4">Editar Fecha de Expiración</h3>

        <!-- Bonus Info (Read-only) -->
        <div class="mb-4 p-4 bg-gray-50 rounded-lg space-y-2">
          <div class="flex justify-between text-sm">
            <span class="text-gray-600">Paciente:</span>
            <span class="font-medium">{{ editingBonus()!.patientName }}</span>
          </div>
          <div class="flex justify-between text-sm">
            <span class="text-gray-600">Bono:</span>
            <span class="font-medium">#{{ editingBonus()!.id }}</span>
          </div>
          <div class="flex justify-between text-sm">
            <span class="text-gray-600">Sesiones:</span>
            <span class="font-medium">{{ editingBonus()!.totalSessions }} sesiones</span>
          </div>
          <div class="flex justify-between text-sm">
            <span class="text-gray-600">Precio total:</span>
            <span class="font-medium">{{ editingBonus()!.totalPrice }}€</span>
          </div>
        </div>

        <form [formGroup]="bonusForm" class="space-y-4">
          <!-- Expiry Date -->
          <div>
            <label for="editExpiryDate" class="block text-sm font-medium text-gray-700 mb-1">
              Fecha de Expiración
            </label>
            <input
              id="editExpiryDate"
              type="date"
              formControlName="expiryDate"
              class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent"
            />
          </div>

          <!-- Actions -->
          <div class="flex justify-end gap-2 pt-4">
            <button
              type="button"
              (click)="closeEditModal()"
              class="px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-md hover:bg-gray-50">
              Cancelar
            </button>
            <button
              type="button"
              (click)="handleEditBonus()"
              [disabled]="!bonusForm.valid"
              style="background-color: #d29f67"
              class="px-4 py-2 text-sm font-medium text-white rounded-md hover:opacity-90 disabled:opacity-50 disabled:cursor-not-allowed">
              Guardar Cambios
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>
}
